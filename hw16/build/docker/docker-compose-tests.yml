version: "3.7"
services:
  calendar_scheduler:
    image: hw16_calendar_scheduler:latest
    depends_on:
      - rabbitmq
      - postgres
    command: sh -c 'sleep 15 && ./bin/scheduler'
  calendar_sender:
    image: hw16_calendar_sender:latest
    depends_on:
      - rabbitmq
      - postgres
    command: sh -c 'sleep 10 && ./bin/sender >> /app/logs/api_log.txt'
    volumes:
      - ./calendar/sender/logs:/app/logs
  calendar_api:
    image: hw16_calendar_api:latest
    depends_on:
      - postgres
    command: sh -c 'sleep 10 && ./bin/api'
    ports:
      - "8888:8081" #web  api
      - "8889:5300" #grpc api
  postgres:
    image: hw16_postgres:latest
    ports:
      - "54441:5432"
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: calendar
  rabbitmq:
    image: hw16_rabbitmq:latest
    ports:
      - "56721:5672"
      - "15677:15672"
    environment:
      RABBITMQ_DEFAULT_PASS: guest
      RABBITMQ_DEFAULT_USER: guest
  godog:
    image: hw16_calendar_godog:latest
    command: sh -c 'sleep 10 && cd tests && godog'
    depends_on:
      - rabbitmq
      - postgres
      - calendar_scheduler
      - calendar_sender
      - calendar_api
